# Semgrep Security Rules for High-Assurance Python
# Used by python-reviewer skill for security pattern detection

rules:
  # ============================================
  # DANGEROUS FUNCTIONS
  # ============================================
  - id: no-eval-exec
    patterns:
      - pattern-either:
          - pattern: eval(...)
          - pattern: exec(...)
    message: "eval() and exec() are dangerous - they execute arbitrary code. Use ast.literal_eval() for data parsing or refactor to avoid dynamic execution."
    languages: [python]
    severity: ERROR

  - id: no-pickle-loads
    patterns:
      - pattern-either:
          - pattern: pickle.loads(...)
          - pattern: pickle.load(...)
          - pattern: cPickle.loads(...)
          - pattern: cPickle.load(...)
    message: "pickle.load/loads can execute arbitrary code during deserialization. Use JSON or a safe serialization format."
    languages: [python]
    severity: ERROR

  # ============================================
  # SUBPROCESS SECURITY
  # ============================================

  - id: subprocess-shell-true
    patterns:
      - pattern: subprocess.$FUNC(..., shell=True, ...)
      - pattern-not: subprocess.$FUNC(..., shell=True, ...) # with proper input validation
    message: "subprocess with shell=True is vulnerable to shell injection. Use shell=False with a list of arguments instead."
    languages: [python]
    severity: ERROR

  - id: os-system-usage
    pattern: os.system(...)
    message: "os.system() is vulnerable to shell injection. Use subprocess.run() with shell=False and a list of arguments."
    languages: [python]
    severity: ERROR

  # ============================================
  # HARDCODED SECRETS
  # ============================================

  - id: hardcoded-password-assignment
    patterns:
      - pattern-either:
          - pattern: $VAR = "..."
          - pattern: $VAR = '...'
      - metavariable-regex:
          metavariable: $VAR
          regex: (?i)(password|passwd|pwd|secret|api_key|apikey|token|auth_token|access_token|private_key)
      - pattern-not: $VAR = ""
      - pattern-not: $VAR = "changeme"
      - pattern-not: $VAR = "placeholder"
    message: "Potential hardcoded secret in variable '$VAR'. Use environment variables or a secrets manager."
    languages: [python]
    severity: ERROR

  - id: hardcoded-secret-in-function-call
    patterns:
      - pattern-either:
          - pattern: $FUNC(..., password="...", ...)
          - pattern: $FUNC(..., api_key="...", ...)
          - pattern: $FUNC(..., secret="...", ...)
          - pattern: $FUNC(..., token="...", ...)
      - pattern-not: $FUNC(..., password="", ...)
      - pattern-not: $FUNC(..., api_key="", ...)
    message: "Hardcoded secret passed to function. Use environment variables or a secrets manager."
    languages: [python]
    severity: ERROR

  # ============================================
  # SQL INJECTION
  # ============================================

  - id: sql-injection-format-string
    patterns:
      - pattern-either:
          - pattern: $CURSOR.execute(f"...", ...)
          - pattern: $CURSOR.execute("..." % ..., ...)
          - pattern: $CURSOR.execute("...".format(...), ...)
    message: "Potential SQL injection via string formatting. Use parameterized queries with placeholders."
    languages: [python]
    severity: ERROR

  # ============================================
  # PATH TRAVERSAL
  # ============================================

  - id: path-traversal-open
    patterns:
      - pattern: open($PATH, ...)
      - pattern-not-inside: |
          $SAFE = os.path.realpath(...)
          ...
          open($SAFE, ...)
    message: "Ensure file paths are validated to prevent path traversal attacks. Use os.path.realpath() and validate the result."
    languages: [python]
    severity: WARNING

  # ============================================
  # INSECURE CRYPTOGRAPHY
  # ============================================

  - id: insecure-hash-md5
    patterns:
      - pattern-either:
          - pattern: hashlib.md5(...)
          - pattern: MD5.new(...)
    message: "MD5 is cryptographically broken. Use SHA-256 or stronger for security-sensitive hashing."
    languages: [python]
    severity: WARNING

  - id: insecure-hash-sha1
    patterns:
      - pattern-either:
          - pattern: hashlib.sha1(...)
          - pattern: SHA.new(...)
          - pattern: SHA1.new(...)
    message: "SHA-1 is deprecated for security use. Use SHA-256 or stronger."
    languages: [python]
    severity: WARNING

  # ============================================
  # UNSAFE YAML
  # ============================================

  - id: unsafe-yaml-load
    pattern: yaml.load(..., Loader=yaml.Loader, ...)
    message: "yaml.load with Loader=yaml.Loader can execute arbitrary code. Use yaml.safe_load() instead."
    languages: [python]
    severity: ERROR

  - id: yaml-load-without-loader
    patterns:
      - pattern: yaml.load($DATA)
      - pattern-not: yaml.load($DATA, Loader=...)
    message: "yaml.load without explicit Loader is unsafe. Use yaml.safe_load() instead."
    languages: [python]
    severity: ERROR

  # ============================================
  # EXCEPTION HANDLING
  # ============================================

  - id: bare-except
    pattern: |
      try:
          ...
      except:
          ...
    message: "Bare 'except:' catches all exceptions including KeyboardInterrupt and SystemExit. Use 'except Exception:' or specific exceptions."
    languages: [python]
    severity: ERROR

  # ============================================
  # TEMPORARY FILES
  # ============================================

  - id: insecure-tempfile
    patterns:
      - pattern-either:
          - pattern: tempfile.mktemp(...)
    message: "tempfile.mktemp() is insecure due to race conditions. Use tempfile.mkstemp() or tempfile.TemporaryFile()."
    languages: [python]
    severity: ERROR

  # ============================================
  # NETWORK SECURITY
  # ============================================

  - id: requests-no-verify
    pattern: requests.$METHOD(..., verify=False, ...)
    message: "SSL certificate verification is disabled. This makes the connection vulnerable to MITM attacks."
    languages: [python]
    severity: ERROR

  - id: urllib-no-verify
    patterns:
      - pattern: ssl._create_unverified_context()
      - pattern: ssl.create_default_context().check_hostname = False
    message: "SSL verification is being disabled. This makes connections vulnerable to MITM attacks."
    languages: [python]
    severity: ERROR
