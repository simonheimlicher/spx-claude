rules:
  # Command Injection
  - id: typescript-command-injection-exec
    patterns:
      - pattern-either:
          - pattern: exec($CMD, ...)
          - pattern: execSync($CMD, ...)
      - pattern-not: exec("...", ...)
      - pattern-not: execSync("...", ...)
    message: >-
      Possible command injection. Use execFile/execFileSync with explicit
      argument arrays instead of exec/execSync with string commands.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78"
      owasp: "A03:2021"

  - id: typescript-command-injection-spawn-shell
    pattern: spawn($CMD, $ARGS, { ..., shell: true, ... })
    message: >-
      Using spawn with shell: true allows command injection.
      Use spawn without shell option or use execFile.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-78"

  # Code Injection
  - id: typescript-eval-usage
    pattern-either:
      - pattern: eval(...)
      - pattern: new Function(...)
      - pattern: setTimeout($STR, ...)
      - pattern: setInterval($STR, ...)
    message: >-
      eval() and similar constructs allow code injection.
      Use safer alternatives like JSON.parse for data or explicit function calls.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-94"
      owasp: "A03:2021"

  # Hardcoded Secrets
  - id: typescript-hardcoded-secret
    patterns:
      - pattern-either:
          - pattern: |
              $KEY = "..."
          - pattern: |
              $KEY: "..."
      - metavariable-regex:
          metavariable: $KEY
          regex: (?i)(password|secret|api_key|apikey|token|auth|credential|private_key)
      - pattern-not: |
          $KEY = ""
      - pattern-not: |
          $KEY = "..."
          where "..." matches "^(test|example|placeholder|xxx|your_).*"
    message: >-
      Possible hardcoded secret in variable '$KEY'.
      Use environment variables or a secrets manager instead.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-798"

  # SQL Injection
  - id: typescript-sql-injection
    patterns:
      - pattern-either:
          - pattern: $DB.query(`...${$VAR}...`)
          - pattern: $DB.query("..." + $VAR + "...")
          - pattern: $DB.execute(`...${$VAR}...`)
      - pattern-not: $DB.query(`...${$LITERAL}...`) where $LITERAL is a literal
    message: >-
      Possible SQL injection. Use parameterized queries instead of
      string interpolation.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-89"
      owasp: "A03:2021"

  # Path Traversal
  - id: typescript-path-traversal
    patterns:
      - pattern-either:
          - pattern: fs.readFile($PATH, ...)
          - pattern: fs.readFileSync($PATH, ...)
          - pattern: fs.writeFile($PATH, ...)
          - pattern: fs.writeFileSync($PATH, ...)
      - pattern-not: fs.readFile("...", ...)
      - pattern-not: fs.readFileSync("...", ...)
      - pattern-not: fs.writeFile("...", ...)
      - pattern-not: fs.writeFileSync("...", ...)
    message: >-
      File path from variable may allow path traversal.
      Validate and sanitize the path, or use path.resolve with a base directory.
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-22"

  # Insecure Randomness
  - id: typescript-insecure-random
    pattern: Math.random()
    message: >-
      Math.random() is not cryptographically secure.
      Use crypto.randomBytes() or crypto.randomUUID() for security-sensitive operations.
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-330"

  # Prototype Pollution
  - id: typescript-prototype-pollution
    patterns:
      - pattern-either:
          - pattern: $OBJ[$KEY] = $VAL
          - pattern: Object.assign($TARGET, $SOURCE)
      - pattern-not: $OBJ["..."] = $VAL
    message: >-
      Possible prototype pollution. Validate keys before using bracket notation
      or use Object.create(null) for dictionaries.
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-1321"

  # Empty Catch Block
  - id: typescript-empty-catch
    pattern: |
      try { ... } catch ($ERR) { }
    message: >-
      Empty catch block swallows errors silently.
      Log the error or rethrow it.
    languages: [typescript, javascript]
    severity: ERROR
    metadata:
      category: correctness

  # Unsafe Type Assertions
  - id: typescript-unsafe-any-cast
    pattern: $EXPR as any
    message: >-
      Casting to 'any' bypasses type safety.
      Use proper type narrowing or 'unknown' with type guards.
    languages: [typescript]
    severity: WARNING
    metadata:
      category: correctness

  # Unhandled Promise
  - id: typescript-floating-promise
    patterns:
      - pattern: $ASYNC_FN(...)
      - pattern-not: await $ASYNC_FN(...)
      - pattern-not: $VAR = $ASYNC_FN(...)
      - pattern-not: return $ASYNC_FN(...)
      - pattern-not: $ASYNC_FN(...).then(...)
      - pattern-not: $ASYNC_FN(...).catch(...)
    message: >-
      Promise may not be handled. Use await, assign to variable,
      or attach .then()/.catch() handlers.
    languages: [typescript, javascript]
    severity: WARNING
    metadata:
      category: correctness
